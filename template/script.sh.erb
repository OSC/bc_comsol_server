#!/usr/bin/env bash

# Load the required environment
setup_env () {
  module purge
  module load comsol/52au3_server
}
setup_env

#
# Start COMSOL Server
#

<%- prefs_dir = Pathname.new(ENV["HOME"]).join(".comsol", session.token) -%>
mkdir -p "<%= prefs_dir %>"

# Copy over default server preferences if it does not exist
<%- server_prefs = prefs_dir.join("server.prefs") -%>
if [[ ! -e "<%= server_prefs %>" ]]; then
  echo "Copying over default server preferences..."
  set -x
  cp \
    "<%= session.staged_root.join("assets", "server.prefs") %>" \
    "<%= server_prefs %>"
  { set +x; } 2>/dev/null
fi

# For debugging purposes output license server information
echo "Output license information..."
set -x
lmutil lmstat -a
{ set +x; } 2>/dev/null

# Set working directory to home directory
cd "${HOME}"

# Launch COMSOL Server
# NB: use -silent or the server will suspend itself
echo "Starting up COMSOL Server..."
set -x
comsol server \
  -serviceport ${port} \
  -prefsdir "<%= prefs_dir %>" \
  -silent \
  -login never
